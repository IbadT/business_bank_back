Оркестратор – многомесячная генерация и общие правила
Компонент Shared Оркестратор управляет процессом генерации выписок, особенно когда запрошено несколько месяцев сразу. Его функции:
•	Параллельный или последовательный вызов микросервисов. Оркестратор получает от пользователя запрос на генерацию выписки (например, на N месяцев начиная с определённой даты) и последовательно вызывает Matematika и Maska для каждого месяца. Для каждого месяца оркестратор формирует контекст: начальный баланс, параметры компании, пользовательские данные – и отправляет их в Matematika. После получения результатов (список транзакций) – передаёт их вместе с необходимыми доп. сведениями в Maska. Полученный от Maska готовый список транзакций сохраняется. Оркестратор повторяет цикл для каждого запрошенного месяца.
•	Наследование данных между месяцами. Один из важнейших аспектов – связь между последовательными выписками:
•	Баланс: Конечный баланс каждого месяца должен становиться начальным балансом следующего. Оркестратор берет finalBalance из выхода Matematika за предыдущий месяц и передаёт его как initialBalance следующему месяцу (если пользователь явно не переопределил начальный баланс вручную для нового периода). Таким образом, счета непрерывны. В JSON выходе каждого месяца указывается initialBalance (что равен предыдущему finalBalance)[80][81].
•	Повторяемость контрагентов (клиентов/подрядчиков): Согласно бизнес-логике, из месяца в месяц не все контрагенты должны меняться. Оркестратор содержит правила вероятности повторения:
o	~60% ± 10% клиентов (доходы) в новом месяце повторяются из предыдущего, и ~40% ± 10% – новые[82].
o	~70% ± 10% подрядчиков (расходы) повторяются, ~30% ± 10% – новые[82].
o	Эти проценты применяются поштучно к списку контрагентов каждого типа. Т.е. оркестратор хранит перечень клиентов и подрядчиков, использованных в предыдущих месяцах, и при генерации нового выбирает некоторую долю из них для повторного использования, остальных заменяет новыми из конфигов.
o	Исключения: Если какая-то категория была отмечена специальным образом. В документе есть понятие типов транзакций, помеченных зелёным – для них должна использоваться одна и та же компания из месяца в месяц (или одинаковый набор компаний)[83]. Вероятно, это касается крупных постоянных контрагентов. Оркестратор обеспечивает, чтобы для зелёных категорий контрагенты вообще не менялись: например, если в категории “Лизинг” первый месяц контрагент ABC Equipment Lease, то во всех следующих месяцах останется он же (эта категория постоянна). Другой пример – оператор мобильной связи: явно сохраняется один и тот же (T-Mobile, Verizon и т.д.) каждый месяц.
o	Оркестратор хранит данные о том, какие контрагенты были использованы для зелёных категорий и общий список последних использованных контрагентов для остальных категорий вместе с счетчиком их повторов. Это сохраняется во внутренней базе/хранилище. Если пользователь сгенерировал сначала 3 месяца, а потом вернулся для генерации ещё 3 месяцев, оркестратор при втором вызове подтянет информацию о ранее использованных контрагентах, чтобы применить правила повторяемости на новых периодах[84]. То есть состояние не сбрасывается между отдельными запросами генерации.
•	Сдвиг календаря и шаблон дней недели. Оркестратор отвечает за то, чтобы паттерны дат (описанные в Matematika) сохранялись последовательно. Например:
•	Если в первом сгенерированном месяце подписка ПО выпала на 3-й вторник, то во втором месяце она тоже должна произойти в 3-й вторник того месяца (если существует; иначе ближайший день). Оркестратор передаёт в Matematika информацию о таких “сидящих” днях: фактически Matematika сама может помнить (через входные параметры) день недели для категории, или Оркестратор может сообщать: «для категории X используй такую же неделю/день, как в прошлом месяце». Это особенно актуально для тех, где «случайно выбирается в первой выписке, и после ежемесячно в этот день недели»[25].
•	Шаблон дней недели сохраняется, даты смещаются – означает, что относительное положение транзакций в неделе повторяется[83]. Например, payroll всегда 2-я и 4-я пятница каждого месяца, это правило уже фиксировано. Для категорий с фиксированным номером дня (как налог 15-го числа) – он всегда 15-го, а если выпадает на выходной/праздник – см. правило сдвига на будний день.
•	Когда месяцы идут последовательно, дни недели сдвигаются (например, 1 февраля может быть продолжением недели января). Оркестратор не должен «ломать» внутреннюю логику: каждая выписка генерируется как отдельный календарный месяц с корректным учётом своего начала (Matematika получает конкретный месяц/год). Поэтому связи типа «последний день месяца» или «первый понедельник месяца» – рассчитываются заново Matematika для каждого месяца. Оркестратор лишь обеспечивает передачу нужных параметров (год, месяц, и сохранённые “базовые” дни недели для определённых событий).
•	Пересчёт сумм для нового месяца. При переходе на следующий месяц могут измениться финансовые показатели (обороты, прибыль и т.д.), особенно если пользователь задаёт тренд или разный оборот по месяцам. Оркестратор либо принимает от пользователя параметры на каждый месяц, либо использует те же, но может вносить случайную вариацию. Например, если пользователь хочет равномерную генерацию, оборот может повторяться; либо можно сделать +/- некоторый процент для реалистичности. В любом случае, Matematika на каждый месяц делает расчёт в пределах своих диапазонов. Проценты и суммы пересчитываются в пределах диапазонов[85], что значит: каждый новый месяц суммы генерируются заново с теми же процентными промежутками, но случайным образом внутри них. Например, если в одном месяце Fuel = 16% оборота, в следующем может быть 15.3% или 17% – оставаясь в 15–17.5% диапазоне.
•	Отдельные категории, где сумма фиксируется в первом месяце (как мобильная связь \$X ±15%) – оркестратор передаёт во второй месяц значение \$X и диапазон +-15%, чтобы Matematika знала от чего плясать. В реализции это может быть сделано через forwardingInfo или хранение в базе: например, сохранить “MobileBill=300.00 в Jan25” и при генерации Feb25 указать Matematika использовать 300±15%. Аналогично для коммунальных.
•	Категории, где решено повторять сумму 1:1 (лизинг) – оркестратор передаёт фиксированное значение без вариаций.
•	Формирование итогового отчёта. Оркестратор собирает результаты Maska для каждого месяца в итоговую структуру. Обычно это массив из объектов по месяцам либо объект, содержащий поля по месяцам. Например, итоговый JSON может выглядеть так:
{
  "companyName": "Srb Autos LLC.",
  "accountNumber": "201290125551",
  "periods": [
    {
      "period": "2025-01-01 - 2025-01-31",
      "initialBalance": 100000.00,
      "transactions": [ ... ], 
      "closingBalance": 163149.16
    },
    {
      "period": "2025-02-01 - 2025-02-28",
      "initialBalance": 163149.16,
      "transactions": [ ... ],
      "closingBalance": 119569.16
    },
    ...
  ]
}
Здесь initialBalance второго периода совпадает с closingBalance первого, как обеспечено логикой оркестратора. Внутри каждого периода – полностью сформированный массив транзакций (уже с описаниями). Такая структура удобна для выгрузки нескольких выписок сразу. В случае генерации одного месяца, periods может содержать один элемент (или система может не оборачивать его в массив, а отдавать просто объект месяца – в зависимости от дизайна API).
